<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Paytone+One&display=swap" rel="stylesheet">
    <!-- css -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/sections/section.css">
    <link rel="stylesheet" href="css/sections/coin-display/coin-card.css">
    <link rel="stylesheet" href="css/sections/coin-display/display.css">
    <link rel="stylesheet" href="css/sections/live-reports-display/display.css">
    <link rel="stylesheet" href="css/sections/about-display/display.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>

<body>
    <div id="topBar"></div>
    <div class="wrapper">
        <header id="header">
            <img src="Image/crypto.JPG" alt="city background" class="background">
            <!-- <img src="Image/spaceship.png" alt="coins" class="foreground"> -->
            <h1 class="title">Crypto Tracker</h1>
            <h2 class="inner-title">Real-time digital currency tracking</h2>
        </header>

        <section>
            <nav class="navbar navbar-expand-lg">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="Image/coins-solid-full.svg" alt="Bootstrap" width="30" height="24">
                        Crypto Tracker</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li id="coinsNav" class="nav-item">
                                <a class="nav-link active" aria-current="page" href="#">Coins</a>
                            </li>
                            <li id="LiveReportsNav" class="nav-item">
                                <a class="nav-link" href="#">Live Reports</a>
                            </li>
                            <li id="aboutNav" class="nav-item">
                                <a class="nav-link" href="#">About</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Display Views -->
            <div id="coinsDisplay" class="display-section">
                <h2>Coins</h2>

                <div class="container-fluid">
                    <form class="d-flex" role="search">
                        <input class="form-control me-2 rounded-pill p-2" type="search" placeholder="Search"
                            aria-label="Search" />
                        <button class="btn btn-outline-success rounded-pill" type="submit">Search</button>
                    </form>
                </div>

                <div class="row g-4" id="coinsGrid">

                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="card coin-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title">Tag</h5>
                                        <p class="card-text">Name</p>
                                        <button type="button" class="btn-more-info btn btn-primary btn-sm rounded-pill"
                                            data-bs-toggle="collapse" data-bs-target="#collapseView"
                                            aria-expanded="false" aria-controls="collapseView">
                                            <i class="bi bi-info-circle-fill"></i>
                                            More info</button>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input switch" type="checkbox" role="switch"
                                            id="switchCheckDefault">
                                    </div>
                                </div>
                                <div class="collapse collapseView" id="collapseView">
                                    <div class=" card-body">
                                        <img src="" alt="">
                                        <div class="price-item">
                                            <span>דולר (Usa): </span>
                                            <span class="price-value"></span>
                                        </div>
                                        <div class="price-item">
                                            <span class="price-label">אירו (EUR): </span>
                                            <span class="price-value"></span>
                                        </div>
                                        <div class="price-item">
                                            <span class="price-label">שקל (ILS): </span>
                                            <span class="price-value"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

                <div id="liveReportsDisplay" class="display-section">
                    <!-- live reports -->
                </div>

                <div id="aboutDisplay" class="display-section">
                    <!-- about -->
                </div>
        </section>
    </div>

    <script>
        $(() => {
            // Nav
            const $coinsNav = $('#coinsNav');
            const $LiveReportsNav = $('#LiveReportsNav');
            const $aboutNav = $('#aboutNav');

            // Displays
            const $coinsDisplay = $('#coinsDisplay');
            const $liveReportsDisplay = $('#liveReportsDisplay');
            const $aboutDisplay = $('#aboutDisplay');

            const $coinsContainer = $('#coinsGrid');

            getCryptoCoins();

            // Events
            $coinsNav.on('click', function () {
                showSection($coinsDisplay);
            });
            $LiveReportsNav.on('click', function () {
                showSection($liveReportsDisplay);
            });
            $aboutNav.on('click', function () {
                showSection($aboutDisplay);
            });

            // Functions
            function showSection(sectionToShow) {
                $(".display-section").hide();
                sectionToShow.show();
            }

            function getCryptoCoins() {
                // קבלת נתונים Api
                fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1')
                    .then(res => res.json())
                    .then(data => {
                        let coins = data.slice(0, 30);
                        coins.forEach((element, index) => {
                            addCoinCard(element, index);
                        });
                    })
                    .catch(err => alert(err));
            }

            function addCoinCard(coin, index) {
                let Card = $('<div>').addClass('col-xl-3 col-lg-4 col-md-6 col-sm-12');
                let inlineCard = $('<div>').addClass('card coin-card');
                let cardBody = $('<div>').addClass('card-body');
                let flex = $('<div>').addClass('d-flex justify-content-between align-items-start');

                //  צד שמאל #####
                let leftDiv = $('<div>');
                leftDiv.append(`<h5 class="card-title">${coin.symbol}</h5>`);
                leftDiv.append(`<p class="card-text">${coin.name}</p>`);

                // כפתור more info
                let moreInfoBtn = $('<button>')
                    .addClass('btn-more-info btn btn-primary btn-sm rounded-pill')
                    .attr({
                        type: 'button',
                    })
                    .html(`<i class="bi bi-info-circle-fill"></i> More info`);

                leftDiv.append(moreInfoBtn);

                //  צד ימין ####
                let switchDiv = $('<div>').addClass('form-check form-switch');
                let switchInput = $('<input>')
                    .addClass('form-check-input switch')
                    .attr({
                        type: 'checkbox',
                        role: 'switch',
                        id: `switchCheckDefault-${index}`
                    });

                switchDiv.append(switchInput);

                // חיבור שני הצדדים
                flex.append(leftDiv);
                flex.append(switchDiv);

                // הוספה ל־card
                cardBody.append(flex);
                inlineCard.append(cardBody);
                Card.append(inlineCard);
                $coinsContainer.append(Card);

                // משתנה לעקוב אחרי מצב הצגה
                let isInfoVisible = false;
                let collapse = null;

                moreInfoBtn.on('click', function () {
                    // אם מוצג כרגע- תסגור נראות
                    // אם לא מוצג בדוק:
                    // אם כבר קיים &&  לא עברו 2 דקות מטעינה אחרונה - תציג שוב
                    // אם לא קיים ||  עברו 2 דקות מטעינה אחרונה - תיצור מחדש ותציג
                    
                    // אם המידע כבר מוצג - נסגור אותו
                    if (isInfoVisible && collapse) {
                        collapse.slideUp(300, function () {
                            collapse.remove();
                            collapse = null;
                        });
                        isInfoVisible = false;
                        moreInfoBtn.html(`<i class="bi bi-info-circle-fill"></i> More info`);
                        return;
                    }

                    // אם המידע לא מוצג - נביא אותו ונציג
                    moreInfoBtn.html(`<i class="bi bi-hourglass-split"></i> Loading...`);

                    fetch(`https://api.coingecko.com/api/v3/coins/${coin.id}`)
                        .then(res => res.json())
                        .then(data => {
                            collapse = $('<div>').css('display', 'none');
                            let collapseBody = $('<div>').addClass('card-body border-top');

                            collapseBody.append(`<img src="${data.image.small}" alt="${coin.name}" class="mb-3">`);
                            collapseBody.append(`
                    <div class="price-item">
                        <span>Dollar (USD): </span>
                        <span class="price-value">$${data.market_data.current_price.usd}</span>
                    </div>
                `);
                            collapseBody.append(`
                    <div class="price-item">
                        <span class="price-label">Euro (EUR): </span>
                        <span class="price-value">€${data.market_data.current_price.eur}</span>
                    </div>
                `);
                            collapseBody.append(`
                    <div class="price-item">
                        <span class="price-label">שקל (ILS): </span>
                        <span class="price-value">₪${data.market_data.current_price.ils}</span>
                    </div>
                `);

                            collapse.append(collapseBody);
                            inlineCard.append(collapse);
                            collapse.slideDown(300);

                            isInfoVisible = true;
                            moreInfoBtn.html(`<i class="bi bi-x-circle-fill"></i> Close`);
                        })
                        .catch(err => {
                            alert('"More info" API error: ' + err);
                            moreInfoBtn.html(`<i class="bi bi-info-circle-fill"></i> More info`);
                        });
                });
            }


        });
    </script>
</body>

</html>